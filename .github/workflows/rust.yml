name: Rust

on:
  - push
  - workflow_dispatch

env:
  CARGO_TERM_COLOR: always
  REGISTRY: ghcr.io

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    # strategy:
    #   fail-fast: false
    #   matrix:
    #     variants:
    #       - platform: linux/amd64
    #         target: x86_64-unknown-linux-gnu
    #       - platform: linux/arm64
    #         target: aarch64-unknown-linux-gnu
    steps:
    - uses: actions/checkout@v3
    - uses: dtolnay/rust-toolchain@stable
      with:
        targets: x86_64-unknown-linux-gnu,aarch64-unknown-linux-gnu
    - name: Build
      run: |
        cargo build --release --target x86_64-unknown-linux-gnu
        cargo build --release --target aarch64-unknown-linux-gnu
    - name: Prepare archive
      run: |
        strip target/release/mongodb-rust-ping
        export BINARY_NAME=mongodb-rust-ping-x86_64-unknown-linux-gnu
        echo "BINARY_NAME=$BINARY_NAME" >> $GITHUB_ENV
        # tar -czvf $ARCHIVE_NAME -C target/release mongodb-rust-ping
    - name: Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: ${{ env.BINARY_NAME }}
    # - name: Log in to the container registry
    #   uses: docker/login-action@v2
    #   with:
    #     registry: ${{ env.REGISTRY }}
    #     username: ${{ github.actor }}
    #     password: ${{ secrets.GITHUB_TOKEN }}
